{"ast":null,"code":"\"use strict\";\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n    r,\n    ar = [],\n    e;\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n  return ar;\n};\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));\n  return ar;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.syncMemoizer = void 0;\nvar lru_cache_1 = __importDefault(require(\"lru-cache\"));\nvar events_1 = require(\"events\");\nvar lodash_clonedeep_1 = __importDefault(require(\"lodash.clonedeep\"));\nvar freeze_1 = require(\"./freeze\");\nfunction syncMemoizer(options) {\n  var cache = new lru_cache_1.default(options);\n  var load = options.load;\n  var hash = options.hash;\n  var bypass = options.bypass;\n  var itemMaxAge = options.itemMaxAge;\n  var freeze = options.freeze;\n  var clone = options.clone;\n  var emitter = new events_1.EventEmitter();\n  var defaultResult = Object.assign({\n    del: del,\n    reset: function () {\n      return cache.reset();\n    },\n    keys: cache.keys.bind(cache),\n    on: emitter.on.bind(emitter),\n    once: emitter.once.bind(emitter)\n  }, options);\n  if (options.disable) {\n    return Object.assign(load, defaultResult);\n  }\n  function del() {\n    var key = hash.apply(void 0, __spread(arguments));\n    cache.del(key);\n  }\n  function emit(event) {\n    var parameters = [];\n    for (var _i = 1; _i < arguments.length; _i++) {\n      parameters[_i - 1] = arguments[_i];\n    }\n    emitter.emit.apply(emitter, __spread([event], parameters));\n  }\n  function isPromise(result) {\n    // detect native, bluebird, A+ promises\n    return result && result.then && typeof result.then === 'function';\n  }\n  function processResult(result) {\n    var res = result;\n    if (clone) {\n      if (isPromise(res)) {\n        res = res.then(lodash_clonedeep_1.default);\n      } else {\n        res = lodash_clonedeep_1.default(res);\n      }\n    }\n    if (freeze) {\n      if (isPromise(res)) {\n        res = res.then(freeze_1.deepFreeze);\n      } else {\n        freeze_1.deepFreeze(res);\n      }\n    }\n    return res;\n  }\n  var result = function () {\n    var args = [];\n    for (var _i = 0; _i < arguments.length; _i++) {\n      args[_i] = arguments[_i];\n    }\n    if (bypass && bypass.apply(void 0, __spread(args))) {\n      emit.apply(void 0, __spread(['miss'], args));\n      return load.apply(void 0, __spread(args));\n    }\n    var key = hash.apply(void 0, __spread(args));\n    var fromCache = cache.get(key);\n    if (fromCache) {\n      emit.apply(void 0, __spread(['hit'], args));\n      return processResult(fromCache);\n    }\n    emit.apply(void 0, __spread(['miss'], args));\n    var result = load.apply(void 0, __spread(args));\n    if (itemMaxAge) {\n      // @ts-ignore\n      cache.set(key, result, itemMaxAge.apply(void 0, __spread(args.concat([result]))));\n    } else {\n      cache.set(key, result);\n    }\n    return processResult(result);\n  };\n  return Object.assign(result, defaultResult);\n}\nexports.syncMemoizer = syncMemoizer;","map":{"version":3,"names":["lru_cache_1","__importDefault","require","events_1","lodash_clonedeep_1","freeze_1","syncMemoizer","options","cache","default","load","hash","bypass","itemMaxAge","freeze","clone","emitter","EventEmitter","defaultResult","Object","assign","del","reset","keys","bind","on","once","disable","key","apply","__spread","arguments","emit","event","parameters","_i","length","isPromise","result","then","processResult","res","deepFreeze","args","fromCache","get","set","concat","exports"],"sources":["../src/sync.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}